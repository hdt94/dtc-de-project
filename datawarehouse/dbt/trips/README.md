# Up and running

Create environment either on cloud or local following instructions from [root README](/README.md).

Install dbt packages:
```bash
dbt deps
```

Environment variables:
- these are generated by root init script [init-env-file.sh](/init-env-file.sh), read [root README](/README.md)
```bash
export BQ_DATASET=
export GCP_PROJECT_ID=
export GCS_DATA_BUCKET_NAME=
export DBT_GCP_CREDENTIALS_FILE=

export DBT_DATABASE=$GCP_PROJECT_ID
export DBT_SCHEMA=$BQ_DATASET

export GS_FHV_RAW_URI="gs://$GCS_DATA_BUCKET_NAME/raw/fhv/*.parquet"
export GS_GREEN_RAW_URI="gs://$GCS_DATA_BUCKET_NAME/raw/green/*.parquet"
export GS_YELLOW_RAW_URI="gs://$GCS_DATA_BUCKET_NAME/raw/yellow/*.parquet"
```

Create source raw external tables:
```bash
dbt run-operation stage_external_sources
```

Compile queries to validate workings:
```bash
dbt compile
```

Building models:
- All models defaults to using `is_test_run: true`
```bash
# build models with LIMIT clause
dbt build

# build models with all available data
dbt build --var 'is_test_run: false'

# build models with view materialization toggling `is_test_run` var
dbt run -m stg_fhv_trips
dbt run -m stg_fhv_trips --var 'is_test_run: false'

# build staging/stg_green_trips.sql downstream with all available data
dbt build -s staging.stg_green_trips+ --var 'is_test_run: false'

# build taxi tables downstream with all available data
dbt build -s staging.stg_green_trips+ -s staging.stg_yellow_trips+ --var 'is_test_run: false'
```

# References
- https://github.com/dbt-labs/dbt-external-tables
